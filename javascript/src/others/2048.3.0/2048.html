<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>2048-Vue</title>
<script src="./vue.js"></script>
<style type="text/css">
.row,.column{
	display: flex;
	display: -webkit-flex;
}
.row{
	flex-flow: row wrap;
	/* -webkit-flex: row wrap; */
}
.column{
	flex-flow: column nowrap;
	/* -webkit-flex: column nowrap; */
}
.app-body{
	width: 28rem;
	height: 28rem;
	border-radius: 10px;
	background: rgb(190,173,158);
	margin: 5rem auto 5rem auto;
	padding: 1rem 0 0 1rem;
}
.button{
	width: 8rem;
	height: 2rem;
	font: 17px/2rem PingFangSC-Medium;
	color: #FFF; 
	border-radius: 5px;
	text-align: center;
	margin: 0 auto 1.8rem auto;
}
.num-box{
	width: 6rem;
	height: 6rem;
	font: 40px/6rem PingFangSC-Semibold;
	font-weight: bold;
	text-align: center;
	margin: 0 1rem 1rem 0;
	border-radius: 10px;
}
.alert-body{
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	text-align: center;
	background: rgba(120,110,100,0.4);

}
.alert-box{
	padding-top: 1rem;
	margin: 20rem auto; 
	width: 26rem;
	height: 16rem;
	font: 28px/3.5rem PingFangSC-Medium;
	color: rgb(122,108,98); 	
	text-align: center;
	background: rgb(239,229,218);
	border-radius: 10px;
}
.end-word{
	font: 20px/2.5rem PingFangSC-Medium;
	color: rgb(239,196,65);
	padding-bottom: 1rem;
}
</style>

</head>
<body>
<h1 style="text-align: center;">2048</h1>
<div id="app">
	<div class="button" v-bind:style="{background: NGrgb[NGflag]}" @mousedown="changeClass()" @mouseup="changeClass()" @click="reset">{{NGmsg}}</div>
	<div style="text-align: center;">score : {{score}}</div>
	<div class="app-body row">
		<div class="num-box" v-bind:style="{background: bgdArr[item], color: fontColorArr[fontColorIndex(item)]}" v-for="(item,index) in getStatus" :id="generateId(index)">{{power(item)}}</div>
	</div>
	<div class="alert-body" v-show="alertSeen">
		<div class="alert-box">
			<span style="font: 45px/5.5rem PingFangSC-Medium;">GAME OVER!</span>
			<div>你获得了{{score}}分</div>
			<div class="end-word">{{endWord}}</div>
			<div class="row">
				<div class="button" v-bind:style="{background: NGrgb[NGflag]}" @mousedown="changeClass()" @mouseup="changeClass()" @click="closeAlert()">退出游戏</div>
				<div class="button" v-bind:style="{background: NGrgb[NGflag]}" @mousedown="changeClass()" @mouseup="changeClass()" @click="reset">再来一局</div>
			</div>
		</div>
	</div>
	<div class="alert-body" v-show="Info.startSeen">
		<div class="alert-box">
			<div v-bind:style="{font:(28+startWord*12)+'px/14rem PingFangSC-Medium'}">{{startArr[startWord]}}</div>
		</div>
	</div>
</div>

<!-- rgb(144,122,101) -->

<script>
var App = new Vue({
	el: '#app',
	data:{
		NGmsg: 'New Game',
    	NGrgb: ['rgb(135,112,90)','rgb(155,130,120)'],
    	NGflag: 1,
    	Info: {
    		startIndex: 0,
    		startSeen: true,
    	},
    	startArr: ['按“上下左右”键控制方块方向', ' 准备好了吗？', '游戏开始!'],
    	//分数
    	score: 0,
		timer: '',
		//当前最大数
		maxStatus: 3,
		alertSeen: false,
		//各数字块的状态码，码代表目前是2^几次方
		statusArr: [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
		fontColorArr: ['rgb(122,108,98)', 'rgb(245,247,241)'],
		bgdArr: ['rgb(205,195,190)', 'rgb(239,229,218)', 'rgb(238,223,198)', 'rgb(248,180,116)', 'rgb(254,156,97)', 'rgb(254,135,95)', 'rgb(249,93,70)', 'rgb(236,205,112)', 'rgb(242,202,90)', 'rgb(241,200,74)', 'rgb(239,196,65)', 'rgb(255,208,17)]'],
		gameOverArr: ['世上竟有如此优秀之人？ Σ(っ °Д °;)っ', '英雄仍需努力！(ง •_•)ง', '这惨不忍睹的分数！ (。>︿<)_θ'],
	},
	// created(){
	// 	document.addEventListener("keyup",this.slide);
	// },
	beforeDestroy() {
		clearTimeout(this.timer);
	},
	methods:{
		changeClass() {
	  		this.NGflag = this.NGflag^1;
	  	},
		generateId(item){
			return "numBox_"+item;
		},
		power(item){
			if(item) return Math.pow(2,item);
			return '';
		},
		closeAlert(){
			this.alertSeen = false;
		},
		fontColorIndex(item){
	  		return Number(item>3);
	  	},
		reset(){
			this.score = 0;
			this.maxStatus = 2;
			let index = Math.floor(Math.random()*16);
			for (let i = 0; i < 16; i++) {
				if (i == index) {
					this.statusArr[i] = Math.floor(Math.random()*this.maxStatus)+1;
				}else{
					this.statusArr[i] = 0;
				}
			};
			this.alertSeen = false;
			this.Info.startIndex = 0;
			this.Info.startSeen = true;
		},
		slide(event){
   			let e = event||window.event;
   			let keycode = e.which;
   			let numStatus = [0, 0, 0, 0];
   			let _this= this;
   			if (keycode === 38) {   				//"up";
   				e.preventDefault();
   				for (let i = 0; i < 4; i++) {//col
   					for(let j = 0; j < 4; j++){//row
   						let index = i+4*j;
   						//当前块位置有值
   						if(this.statusArr[index] != 0){
   							//判断当前列此前是否有值，有值则判断是否与当前值相等，且小于2048
   							if (numStatus[i] && (this.statusArr[index] == this.statusArr[i+4*(numStatus[i]-1)]) && (this.statusArr[i+4*(numStatus[i]-1)]<11)) {
								//相等则合并，更新Maxstatus,更新分数
								this.statusArr[i+4*(numStatus[i]-1)] = this.statusArr[index] + 1;
								this.score += this.statusArr[i+4*(numStatus[i]-1)];
								this.statusArr[index] = 0;	
								//合并完了之后，继续比较此前的值是否相等，相等则继续合并
								while(numStatus[i]>1 && (this.statusArr[i+4*(numStatus[i]-2)] == this.statusArr[i+4*(numStatus[i]-1)])){
									Vue.set(this.statusArr,this.statusArr);
									numStatus[i]--;
									this.statusArr[i+4*(numStatus[i]-1)]+=1;
									this.score += this.statusArr[i+4*(numStatus[i]-1)];
									this.statusArr[i+4*numStatus[i]] = 0;
								}
   							}else{
								//当前列无值或者值不相等转移至靠边位置
   								//当前列个数+1
   								if (i+4*numStatus[i] != index) {
									this.statusArr[i+4*numStatus[i]] = this.statusArr[index];
   									this.statusArr[index] = 0;
   								}
   								numStatus[i]++;
   							}
   						}
   					}
   				}
   			}else if(keycode === 40 ){        		//"down";
   				e.preventDefault();
   				for (let i = 0; i < 4; i++) {//col
   					for(let j = 3; j >= 0 ; j--){//row
   						let index = i+4*j;
   						//当前块位置有值
   						if(this.statusArr[index] != 0){
   							//判断当前列此前是否有值，有值则判断是否与当前值相等，
   							if (numStatus[i] && (this.statusArr[index] == this.statusArr[i+4*(4-numStatus[i])]) && (this.statusArr[i+4*(4-numStatus[i])] < 11)) {
								//相等则合并，更新Maxstatus,更新分数
								this.statusArr[i+4*(4-numStatus[i])] = this.statusArr[index] + 1;
								this.score += this.statusArr[i+4*(4-numStatus[i])];
								this.statusArr[index] = 0;
								while(numStatus[i]>1 && (this.statusArr[i+4*(5-numStatus[i])] == this.statusArr[i+4*(4-numStatus[i])])){
									Vue.set(_this.statusArr,_this.statusArr);
									numStatus[i]--;
									this.statusArr[i+4*(4-numStatus[i])]+=1;
									this.score += this.statusArr[i+4*(4-numStatus[i])];
									this.statusArr[i+4*(3-numStatus[i])] = 0;
								}
   							}else{
								//当前列无值或者值不相等转移至靠边位置
   								//当前列个数+1
   								if (i+4*(3-numStatus[i]) != index) {
									this.statusArr[i+4*(3-numStatus[i])] = this.statusArr[index];
   									this.statusArr[index] = 0;
   								}
   								numStatus[i]++;
   							}
   						}
   					}
   				}
    		}else if(keycode === 37){        		//"left";
   				for (let i = 0; i < 4; i++) {//row
   					for(let j = 0; j < 4; j++){//col
   						let index = j+4*i;
   						//当前块位置有值
   						if(this.statusArr[index] != 0){
   							//判断当前行此前是否有值，有值则判断是否与当前值相等，
   							if (numStatus[i] && (this.statusArr[index] == this.statusArr[numStatus[i]-1+4*i]) && (this.statusArr[numStatus[i]-1+4*i] < 11)) {
								//相等则合并，更新Maxstatus,更新分数
								this.statusArr[numStatus[i]-1+4*i] = this.statusArr[index] + 1;
								this.score += this.statusArr[numStatus[i]-1+4*i];
								this.statusArr[index] = 0;
								while(numStatus[i]>1 && (this.statusArr[numStatus[i]-1+4*i] == this.statusArr[numStatus[i]-2+4*i])){
					   				Vue.set(_this.statusArr,_this.statusArr);
									numStatus[i]--;
									this.statusArr[numStatus[i]-1+4*i]+=1;
									this.score += this.statusArr[numStatus[i]-1+4*i];
									this.statusArr[numStatus[i]+4*i] = 0;
								}
   							}else{
								//当前行无值或者值不相等转移至靠边位置
   								//当前行个数+1
   								if (numStatus[i]+4*i != index) {
									this.statusArr[numStatus[i]+4*i] = this.statusArr[index];
   									this.statusArr[index] = 0;
   								}
   								numStatus[i]++;
   							}
   						}
   					}
   				}
    		}else if(keycode === 39){        		//"right";
   				for (let i = 0; i < 4; i++) {//row
   					for(let j = 3; j >= 0; j--){//col
   						let index = j+4*i;
   						//当前块位置有值
   						if(this.statusArr[index] != 0){
   							//判断当前行此前是否有值，有值则判断是否与当前值相等，
   							if (numStatus[i] && (this.statusArr[index] == this.statusArr[4-numStatus[i]+4*i]) && (this.statusArr[4-numStatus[i]+4*i] < 11)) {
								//相等则合并，更新Maxstatus,更新分数
								this.statusArr[4-numStatus[i]+4*i] = this.statusArr[index] + 1;
								this.score += this.statusArr[4-numStatus[i]+4*i];
								this.statusArr[index] = 0;
								// this.maxStatus = this.maxStatus>this.statusArr[4-numStatus[i]+4*i] ? this.maxStatus:this.statusArr[4-numStatus[i]+4*i];
								while(numStatus[i]>1 && (this.statusArr[4-numStatus[i]+4*i] == this.statusArr[5-numStatus[i]+4*i])){
					   				Vue.set(_this.statusArr,_this.statusArr);
									numStatus[i]--;
									this.statusArr[4-numStatus[i]+4*i]+=1;
									this.score += this.statusArr[4-numStatus[i]+4*i];
									this.statusArr[3-numStatus[i]+4*i] = 0;
								}
   							}else{
								//当前行无值或者值不相等转移至靠边位置
   								//当前行个数+1
   								if (3-numStatus[i]+4*i != index) {
									this.statusArr[3-numStatus[i]+4*i] = this.statusArr[index];
   									this.statusArr[index] = 0;
   								}
   								numStatus[i]++;
   							}
   						}
   					}
   				}
   			};
   			this.timer = setTimeout(function() {
   				Vue.set(_this.statusArr,_this.statusArr);
   			}, 200);
		},

	},
	computed: {
	  	getStatus:{
	  		get(){
	  			let index = Math.floor(Math.random()*16);
	  			let flag = 0;
	  			while(this.statusArr[index] != 0 && flag<16) {
	  				index = Math.floor(Math.random()*16);
	  				flag++;
	  			};
	  			if (flag == 16) {
	  				for (let i = 0; i < 16; i++) {
	  					if (this.statusArr[i] == 0){
	  						index = i;
	  						flag = 0;
	  					}
	  				}
	  				if(flag){
		  				this.alertSeen = true;
		  				document.removeEventListener("keydown",this.slide);
		  				return this.statusArr;
	  				}
	  			}
	  			this.statusArr[index] = Math.floor(Math.random()*this.maxStatus)+1;
	  			return this.statusArr;
	  		},
	  	},
	  	endWord:{
	  		get(){
	  			let index;
	  			if (this.score<300){index = 2;}
	  			else if(this.score>600) {index = 0;}
	  			else {index = 1;}
	  			return index,this.gameOverArr[index];
	  		}
	  	},
	  	startWord:{
	  		get(){
	  			let _this = this;
	  			if(this.Info.startIndex<3){
		  			this.timer = setTimeout(function() {
		  				//此处如果直接使用this指向的不是vue.App,而是setTimeout,因此获取不到startIndex,将外面的this赋值一下即可正常调用
		  				_this.Info.startIndex++;
		  				document.removeEventListener("keydown", _this.slide);
		  			}, 1000);
	  			}else{
	  				_this.Info.startSeen = false;
	  				document.addEventListener("keydown", this.slide);
	  			}
	  			return this.Info.startIndex;
	  		},
	  	},

	},

});
</script>
</body>
</html>